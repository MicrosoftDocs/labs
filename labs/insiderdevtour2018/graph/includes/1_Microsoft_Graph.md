# Microsoft Graph

----------

# Intro to Graph

## Brief explanation of what is Graph

Microsoft Graph is an API built in Office 365 that allows developers to integrate with devices, Office 365, Azure and develop more intelligent and productive applications.

Thanks to Microsoft Graph we can integrate services such as Azure AD, OneDrive, Outlook, Excel, OneNote, Intune, SharePoint or Planner and other Office products.
  
The best thing about Graph is that integration is simple via the REST API, with only a few lines of code giving access to a large amount of information.  

At the core of Microsoft Graph are the concepts of the user and group.

A user in Microsoft Graph is one of millions who use Microsoft 365 cloud services. It is critical that user identity is protected and access is well managed. The user's data is what drives business. Microsoft Graph services makes this data available to businesses in rich contexts, with real-time updates, deep insights, and always with the appropriate permissions.

An Office 365 group is the fundamental entity that lets users collaborate. It integrates with other services, enabling richer scenarios in task planning, teamwork, education, and more.

In summary, Microsoft Graph forms a network of Microsoft 365 services and features that manage, protect, and extract data to support a wide range of scenarios. Microsoft Graph lets you access this wealth of user data while always respecting proper authorization.


## Timeline

Microsoft Graph has a new future: **UserActivity**.  
User Activities generated by your application appear in Timeline. By writing User Activities into the Microsoft Graph, you can express specific content within your application as a destination which is showcased in Windows, and accessible on your iOS and Android devices.

Each User Activity represents a single destination within your app. When you engage with that activity (by creating an Activity Session), the system creates a history record indicating the start and end time for that activity. As you re-engage with that User Activity over time, multiple History Records will be recorded for a single User Activity.

When activities appear in Timeline, we display them using the [Adaptive Card](http://adaptivecards.io/) framework. You can configure these cards or if you do not provide an adaptive card, Timeline will automatically create a simple Adaptive card based in your activity. 

## Why is it useful?

Microsoft Graph, by allowing us to connect with all our Office 365 data, allows us to integrate this data into our applications easily, quickly and safely.

With Microsoft Graph we do the following:

 - Sends alerts if you're spending too much time in meetings.
 - Suggest the best time for the next team meeting according to your calendar.
 - Create a Team in Microsoft Teams for an existing office 365 Group.
 - Send a notification when people are added to Active Directory and automatically kick off employee on-boarding workflows.
 - Continue editing a document where you left off in another device .
 - Create a timeline with all your activity. 
   
These are some examples of what can be done with Graph, but you can see there are many scenarios where you can apply.

Nowadays one of the biggest uses of Microsoft Graph API is to share information between different devices, allowing us to save the information of our applications, their status, their configuration and to be able to follow exactly the same point in another device with an application developed in a different technology.

## Interesting links

There is a wealth of information about Microsoft Graph and this is a list of interesting links we recommend:

- [https://developer.microsoft.com/en-us/graph/docs/concepts/overview](https://developer.microsoft.com/en-us/graph/docs/concepts/overview). Official website of Microsoft Graph where you can find all the updated documentation.

- [https://github.com/microsoftgraph](https://github.com/microsoftgraph). Microsoft Graph API Repository on GitHub. 

- [https://github.com/Microsoft/project-rome](https://github.com/Microsoft/project-rome). Project Rome's GitHub Repository, where you can find information and examples.

- [https://channel9.msdn.com/events/Build/2017/B8025](https://channel9.msdn.com/events/Build/2017/B8025). Microsoft Build 2017 video showing how to work with Project Rome and Graph
	
## Objectives of the lab

The objectives of this lab are:


- Learn what Microsoft Graph is and what it is for.
- Learn about Microsoft Graph Explorer
- Introduction to the use of Microsoft Graph API through several examples focusing on authentication, OneDrive and Outlook.
- Finally, how to prepare our application so that it will appear on Timeline and we can pick up where we left off. 

# Getting Started with Quick Start
In order for our applications to use the Microsoft Graph API, we must have an application ID.

We must register the application in the Microsoft Application Registry. 

> Note: You will need either a [school or work](https://developer.microsoft.com/en-us/office/dev-program) or [Microsoft account](https://signup.live.com/signup?wa=wsignin1.0&ct=1473983465&rver=6.6.6556.0&wp=MBI_SSL&wreply=https://outlook.live.com/owa/&id=292841&CBCXT=out&cobrandid=90015&bk=1473983466&uiflavor=web&uaid=3b7bae8746264c1bacf1db2b315745cc&mkt=EN-US&lc=1033&lic=1)

## Setting up app id
### Register the app in App Registration Portal
First, go to [Microsoft App Registration Portal](https://apps.dev.microsoft.com/)

> **Note:** Login with your  [school or work](https://developer.microsoft.com/en-us/office/dev-program) or [Microsoft account](https://signup.live.com/signup?wa=wsignin1.0&ct=1473983465&rver=6.6.6556.0&wp=MBI_SSL&wreply=https://outlook.live.com/owa/&id=292841&CBCXT=out&cobrandid=90015&bk=1473983466&uiflavor=web&uaid=3b7bae8746264c1bacf1db2b315745cc&mkt=EN-US&lc=1033&lic=1)

After login we follow these steps:

 1. Choose Add an app
  
    ![alt text](../media/AddApplication.png) 
	

	> **Note**: If you signed in with a work or school account, select the **Add an app** button for **Converged applications**.

 2. Enter an app name and click **Create**
	
	![alt text](../media/RegisterApp.png) 

	> **Note**: After creation, the page display a list of properties.	


 3. Copy the Application Id and save it to a document as we will need it later 
	
	![alt text](../media/ApplicationID.png) 

	> **Note**: We will need the **Application Id** to configure our app.	

 4. Now, we click on Add Platform and select Native Application 	
	
	![alt text](../media/NativeApplication.png) 

	> **Note**: In our case we select **Native Application** because we will use an **UWP app**

 5. The Built-in redirect URI value has been created automatically. Save this value to the same document as the Application Id for future reference. 
	
	![alt text](../media/RedirectUri.png) 
 
 6. Finally, we click on Save. 

## Choosing the project template

Now we will download the UWP application. We will use it and configure it with the Application Id and the Redirect Uri that we saved before.

#### Prerequisites

To run the application you must have the following configuration:

1. Install or update [Visual Studio Community 2017](https://www.visualstudio.com/vs/) or [Visual Studio Enterprise 2017](https://www.visualstudio.com/vs/), version 15.7+
2. Verify Windows 10 [development mode](https://docs.microsoft.com/windows/uwp/get-started/enable-your-device-for-development#accessing-settings-for-developers) is enabled.
3. Make sure that you've installed the tools for[ Windows 10 development(Build 17134 or higher)](https://developer.microsoft.com/windows/downloads)
4. You have installed Windows 10 April 2018 update.

#### Download UWP project from Github 

Download project form [here](https://github.com/Microsoft/InsiderDevTour18-Labs/tree/master/graph) 

#### Build and Debug

Now we configure the app with the Application Id and Redirect URI.
Open the App.xaml file and add this code:

	<Application.Resources>
        <x:String x:Key="ida:ClientID">ENTERYOURCLIENTID</x:String>
        <x:String x:Key="ida:ReturnUrl">ENTERYOURREDIRECTURI</x:String>
    </Application.Resources>

> Change **ENTERYOURCLIENTID** for your Application Id and **ENTERYOURREDIRECTURI** for the Redirect Uri we saved before

 
To Build and run the applications follow this steps.

1. Now select x86 as build target.
2. Select Local Machine.
3. Build the application.
4. Run the application.

If everything is properly configured you will see:

![alt text](../media/applicationrun.png) 

# Graph Explorer

Graph Explorer is a tool that allows us to explore and test Microsoft Graph API.

We are going to take a tour of this tool.

## Sign in to Graph Explorer

Go to **[Graph Explorer](https://developer.microsoft.com/en-us/graph/graph-explorer)** and click on the Sign in With Microsoft button. 

 ![alt text](../media/LoginGraphApi.png) 

> Note: You will need login with a [school or work](https://developer.microsoft.com/en-us/office/dev-program) or [Microsoft account](https://signup.live.com/signup?wa=wsignin1.0&ct=1473983465&rver=6.6.6556.0&wp=MBI_SSL&wreply=https://outlook.live.com/owa/&id=292841&CBCXT=out&cobrandid=90015&bk=1473983466&uiflavor=web&uaid=3b7bae8746264c1bacf1db2b315745cc&mkt=EN-US&lc=1033&lic=1)

After the login you can see that on the left side we have several options:


- We can modify our permissions.
- We can log out.
- We can see the APIS with some services by default but we can add APIS from show more samples button.

On the right side we have the view with everything we need to launch the calls against the APIs and see the requests and the response.

Now we will see how to test the Graph API in Microsoft Graph Explorer by getting all files in One Drive and how we can manage our permissions.

## Modify user permissions

In order to use and access the different services, we can modify the permissions of our user to give him the necessary privileges to be able to use the desired operations.

- Choose Modify Permissions.

 ![alt text](../media/GEModifyPermissions.png) 


- Now we can see the list of permissions and you can activate or deactivate individual permissions.

![alt text](../media/GESelectPermissions.png) 


## Activate OneDrive in Sample Categories

Now we are going to add the OneDrive APIs to Graph Explorer to be able to call these services


- Choose show more samples.

![alt text](../media/GEShowMoreExamples.png) 

- Find OneDrive and activate it. 

![alt text](../media/GESelectOneDrive.png) 


- Now OneDrive APIs are included in Graph Explorer.

![alt text](../media/GEShowOneDriveSamples.png) 


# Get all items in my drive

We are ready to get all items from OneDrive

- Select in the left menu **all the items in my drive** under **OneDrive** section
- Automatically Graph Explorer sends a call to OneDrive API and shows the results.

![alt text](../media/GEGetAllODItems.png) 


Now let's get a single file.  
From the left panel select my recent files and copy the id field in the remoteItem object.
To get the single file, put it in the url:

	https://graph.microsoft.com/v1.0/me/drive/items/{your_file_id}

If you want the thumbnails, use this url:

	https://graph.microsoft.com/v1.0/me/drive/items/{your_file_id}/thumbnails
# Sample API calls

At this point we are ready to interact with Microsoft Graph.

To do this we will create a console application to which we add the necessary code to perform authentication using Microsoft Graph and then we will list all the documents that we have in OneDrive.

## Create a console app

Download the base project from [here](https://github.com/Microsoft/InsiderDevTour18-Labs/tree/master/graph)

## Authenticate user

Now let's add the authentication.

- In App.config add

    	<appSettings>
    		<add key="ida:ClientID" value="YOURCLIENTID"/>
    		<add key="ida:ReturnUrl" value="YOURREDIRECTURI"/>
    	</appSettings>
    
	
>Change the value **YOURCLIENTID** for the Application Id that we obtained when registering the application, and do the same with **YOURREDIRECTURI**


- Go to AuthenticationHelper.cs
- Delete the code

   	`throw new NotImplementedException();`

- Add the following code

	      try
            {
                graphClient = new GraphServiceClient(
                    "https://graph.microsoft.com/v1.0",
                    new DelegateAuthenticationProvider(
                        async (requestMessage) =>
                        {
                            var token = await GetTokenForUserAsync();
                            requestMessage.Headers.Authorization = new AuthenticationHeaderValue("bearer", token);                            

                        }));
                return graphClient;
            }

            catch (Exception ex)
            {
                Debug.WriteLine("Could not create a graph client: " + ex.Message);
            }

            return graphClient;

You can see that we use the Graph Service Client to authenticate, obtain the token, and later access all of Graph resources through the class found in the Microsoft.Graph NuGet package.

The method **GetTokenForUserAsync** obtain the access token after the user are authenticated to send in Authentication header when call the API.

Now you can build and run the process and the application will ask for user credentials via Graph.
When you are authenticated, please answer **N** to the answer **Would you like to see your OneDrive items?[Y] Yes or [N] No**

![alt text](../media/AuthConsola.png)

## Get call to Get all items in OneDrive
Now we are ready to make calls to the API, we will call OneDrive API to show the name of the documents we have.


> **Advice:** the application ask for a number of documents to show. If you don't want to wait a lot, please enter a small number.

For the call to **OneDrive** follow these steps:

- Go to OneDriveHelper.cs.
- Delete the code.
	
	`throw new NotImplementedException();`
-  Add this code:
 			
	       List<string> filesName = new List<string>();

            try
            {
                var graphClient = AuthenticationHelper.GetAuthenticatedClient();
                var onedrive = graphClient.Me.Drive.Root.Children.Request().GetAsync().Result;

                filesName = GetNameFiles(graphClient, filesName, onedrive, numberOfElements);
               
                return filesName;
            }

            catch (Exception ex)
            {
                Debug.WriteLine("Could not create a graph client: " + ex.Message);
                throw;
            }

There are few interesting points in the code before:

- We call the authentication method to obtain the Graph context with the authenticated user.
- After that we can access the different GRAPH resources of the user.
- In our case we access the root of OneDrive.
- And then we search for the files by going through all the folders with the recursive GetNameFiles method.

![alt text](../media/OneDriveConsole.png)

# Adding API calls to your project

Now we have an overview about how to work with Microsoft Graph. Now we will go back to our UWP and add user authentication.

## Add user authentication with Graph
Open UWP code in Visual Studio and follow these steps.

- Go to Helpers/AuthenticationHelper.cs
- In GetAuthenticatedClient() Method
- Delete this code:

   	`throw new NotImplementedException();`

- Add the following code:

		if (graphClient == null)
            {
                // Create Microsoft Graph client.
                try
                {
                    graphClient = new GraphServiceClient(
                        "https://graph.microsoft.com/v1.0",
                        new DelegateAuthenticationProvider(
                            async (requestMessage) =>
                            {
                                var token = await GetTokenForUserAsync();
                                requestMessage.Headers.Authorization = new AuthenticationHeaderValue("bearer", token);
                            }));
                    return graphClient;
                }

                catch (Exception ex)
                {
                    Debug.WriteLine("Could not create a graph client: " + ex.Message);
                }
			}
			return graphClient;


As you can see it is exactly the same code that we used in the console application, and this is because for the UWP application we have used the same NuGet package.

> **Note:** In previous steps we configured the **ClientID** and **ReturnURL** field in the App.xaml file. Check that you have added them correctly.

Now run the application and click the **Log in** menu button to authenticate.
